<div class="page-loader" *ngIf="eventDataLoading">
  <mat-spinner></mat-spinner>
</div>
<div id="eventDetailsContainer" *ngIf="!eventDataLoading">

  <div class="detailsDiv">
    <mat-card>
      <div class="event-detail-action-bar">
        <button mat-raised-button color="primary" class="event-detail-action-button" (click)="openEventDetailsShare()">
          <i class="material-icons">share</i> Share</button>
        <!-- <button mat-raised-button color="primary" class="event-detail-action-button">
          <i class="material-icons">print</i> Print Event Details</button> -->
        <button mat-raised-button color="primary" class="event-detail-action-button" (click)="exportEventDetails()">
          <i class="material-icons">unarchive</i> Export Event Data</button>
      </div>
      <mat-card-title class="details-info">
        <div class="title">Event {{eventData.id}}</div>
        <div class="subtitle">{{eventData.event_type_string}}</div>
        <div class="meta">
          <span>{{eventData.start_date | date:'mediumDate'}}</span>
          <span> thru </span>
          <span>{{eventData.end_date | date:'mediumDate'}}</span>
        </div>
      </mat-card-title>
      <!-- <mat-card-subtitle>{{eventData.event_type_string}}</mat-card-subtitle> -->
      <mat-card-content *ngIf="!eventDataLoading">
        <div id="public-event-data">
          <p>
            <div class="event-header">
              <table>
                <tr>
                  <th>Affected</th>
                  <td>{{eventData.affected_count}}</td>
                </tr>
                <tr>
                  <th [attr.rowspan]="eventData.eventdiagnoses.length + 1 ">Diagnosis</th>
                </tr>
                <tr *ngFor="let diagnosis of eventData.eventdiagnoses" class="noBorder">
                  <td>{{diagnosis.diagnosis_string}}</td>
                </tr>
                <tr>
                  <th [attr.rowspan]="eventData.eventlocations.length + 1 ">Locations</th>
                </tr>
                <tr *ngFor="let eventLocation of eventData.eventlocations">
                  <td>{{eventLocation.administrative_level_two_string}},
                    {{eventLocation.administrative_level_one_string}}
                    <br>{{eventLocation.country_string}} <br><span class="text-italic"><span>{{eventLocation.start_date
                        | date:'mediumDate'}}</span>
                      <span> thru </span>
                      <span>{{eventLocation.end_date | date:'mediumDate'}}</span></span></td>
                </tr>
              </table>
            </div>
            <p>

              <div class="event-header">
                <label>Event Organizations</label>
                <table id="speciesList">
                  <tr>
                    <th>Organization</th>
                    <th>Address</th>
                    <th>Phone</th>
                  </tr>

                  <tr *ngFor="let eventOrganization of eventData.eventorganizations">
                    <td>{{eventOrganization.name}}</td>
                    <td>{{eventOrganization.address_one}} {{eventOrganization.address_two}} ,
                      {{eventOrganization.city}} {{eventOrganization.administrative_level_one |
                      displayValue:'abbreviation':this.administrative_level_one }} {{eventOrganization.postal_code}}</td>
                    <td>{{eventOrganization.phone}}</td>
                  </tr>
                </table>
              </div>
              <br>
              <div class="event-details">
                <p>
                  <!-- <label for="speciesList" class="event-detail-label">Species Affected</label> -->
                  <table id="speciesList">
                    <tr>
                      <th>Species</th>
                      <th>Location</th>
                      <th>Population</th>
                      <th>Sick</th>
                      <th>Dead</th>
                      <th class="limit-width">Sick Estimate </th>
                      <th class="limit-width">Dead Estimate</th>
                      <th class="limit-width">Captive</th>
                      <th>Age Bias</th>
                      <th>Sex Bias</th>
                      <th>Diagnosis</th>
                    </tr>

                    <tr *ngFor="let loc_species of eventLocationSpecies">
                      <td>{{loc_species.species_string}}</td>
                      <td>
                        <span>{{loc_species.administrative_level_two_string}},
                          {{loc_species.administrative_level_one_string}}</span>
                        <br>
                        <span>{{loc_species.country_string}}</span>
                      </td>
                      <td>{{loc_species.population_count}}</td>
                      <td>{{loc_species.sick_count}}</td>
                      <td>{{loc_species.dead_count}}</td>
                      <td>{{loc_species.sick_count_estimated}}</td>
                      <td>{{loc_species.dead_count_estimated}}</td>
                      <td>{{loc_species.captive ? 'Yes' : 'No'}}</td>
                      <td>{{loc_species.age_bias | displayValue:'name':this.ageBiases}}</td>
                      <td>{{loc_species.sex_bias | displayValue:'name':this.sexBiases}}</td>
                      <td>
                        <span *ngIf="loc_species.speciesdiagnoses.length > 0">
                          <span *ngFor="let speciesdiagnosis of loc_species.speciesdiagnoses">
                            <span class="text-bold" *ngIf="speciesdiagnosis">{{speciesdiagnosis.diagnosis_string}}</span>
                            <br>
                            <span *ngIf="speciesdiagnosis.causal">(Causal)</span>
                            <br>
                            <span>{{speciesdiagnosis.tested_count}} specimens tested |</span>
                            <span>{{speciesdiagnosis.positive_count}} positive</span>
                            <br>
                            <span *ngIf="speciesdiagnosis.organizations_string"> by
                              {{speciesdiagnosis.organizations_string[0]}}</span>
                          </span>
                        </span>
                        <span *ngIf="loc_species.speciesdiagnoses.length === 0">Not assessed</span>
                      </td>
                    </tr>
                  </table>
                  <div>

                  </div>
              </div>
        </div>
        <p>

          <div id="privileged-event-data" class="privileged-event-data" *ngIf="currentUser.role != 7 && currentUser.role != undefined">


            <mat-divider [inset]="true"></mat-divider>
            <br>

            <label class="event-detail-label">Privileged Event Data</label>
            <br />

            <mat-chip-list [selectable]="false">
              <label>You have these permissions on this event:</label>
              <mat-chip color="accent" *ngIf="eventData.permissions.read === true">Read</mat-chip>
              <mat-chip color="primary" *ngIf="eventData.permissions.update === true">Update</mat-chip>
              <mat-chip color="primary" *ngIf="eventData.permissions.write=== true">Create</mat-chip>
              <mat-chip color="warn" *ngIf="eventData.permissions.destroy === true">Delete</mat-chip>
            </mat-chip-list>

            <p>
              <table>
                <tr>
                  <th>Event Owner</th>
                  <td><span *ngIf="eventOwner">{{eventOwner.first_name}} {{eventOwner.last_name}}
                      ({{eventOwner.organization_string}})</span></td>
                </tr>
                <tr>
                  <th>Event Reference</th>
                  <td>{{eventData.event_reference}}</td>
                </tr>
                <tr>
                  <th>Event Status</th>
                  <td>{{eventData.event_status_string}}</td>
                </tr>
                <tr>
                  <th>Created Date</th>
                  <td>{{eventData.created_date}}</td>
                </tr>
                <tr>
                  <th>Last Modified Date</th>
                  <td>{{eventData.modified_date}}</td>
                </tr>
                <tr>
                  <th>Staff</th>
                  <td>{{eventData.staff}}</td>
                </tr>
                <tr>
                  <th>Quality Check</th>
                  <td>{{eventData.quality_check ? 'Yes' : 'No'}}</td>
                </tr>
                <tr>
                  <th>Complete</th>
                  <td>{{eventData.complete ? 'Yes' : 'No'}}</td>
                </tr>
                <tr>
                  <th>Legal Status</th>
                  <td>{{eventData.legal_status_string}}</td>
                </tr>
                <tr>
                  <th>Legal Number</th>
                  <td>{{eventData.legal_number}}</td>
                </tr>
                <tr>
                  <th>Superevent</th>
                  <td></td>
                </tr>

              </table>

              <br>
              <div class="event-detail-action-bar">
                <button mat-raised-button color="primary" class="event-detail-action-button" (click)="editEvent(id)"
                  [disabled]="!eventData.permissions.update">
                  <mat-icon>edit</mat-icon> Edit Event</button>
                <button mat-raised-button color="primary" class="event-detail-action-button" (click)="addEventDiagnosis(id)"
                  [disabled]="!eventData.permissions.write">
                  <mat-icon>add</mat-icon> Add Event Diagnosis</button>
              </div>

              <p>
                <mat-card-subtitle>Event Comments</mat-card-subtitle>
                <div *ngIf="eventData.comments.length > 0">
                  <mat-card *ngFor="let commment of eventData.comments">
                    <mat-card-header>
                      <mat-card-title>{{comment.comment_type}}</mat-card-title>
                      <mat-card-subtitle>{{comment.created_date}}</mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content>{{comment.comment}}</mat-card-content>
                  </mat-card>
                </div>

                <p>
                  <mat-card-subtitle>Event Location Details</mat-card-subtitle>

                  <mat-expansion-panel *ngFor="let eventLocation of eventData.eventlocations; let i = index"
                    [attr.data-index]="i" (change)="panelDataChange()">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <mat-icon>location_on</mat-icon> {{determineLocationName(eventLocation.name,i+1)}}
                      </mat-panel-title>
                    </mat-expansion-panel-header>

                    <!--Begin new event location mark up-->
                    <div class="details-info">

                      <span class="text-larger text-bold">
                         {{eventLocation.administrative_level_two_string}},
                        {{eventLocation.administrative_level_one_string}},
                        {{eventLocation.country_string}}
                      </span> <br>

                      <div>
                        <mat-icon>date_range</mat-icon>
                        <span> {{eventLocation.start_date | date:'mediumDate'}}</span>
                        <span> thru </span>
                        <span>{{eventLocation.end_date | date:'mediumDate'}}</span>
                      </div>

                      <table>
                        <tr>
                          <th>Land ownership</th>
                          <td>{{eventLocation.land_ownership | displayValue:'name':this.landownerships}}</td>
                        </tr>
                        <tr>
                          <th>GNIS Feature Name</th>
                          <td>{{eventLocation.gnis_name}}</td>
                        </tr>
                        <tr>
                          <th>GNIS Feature ID</th>
                          <td>{{eventLocation.gnis_id}}</td>
                        </tr>
                        <tr>
                          <th>Latitude</th>
                          <td>{{eventLocation.latitude}}</td>
                        </tr>
                        <tr>
                          <th>Longitude</th>
                          <td>{{eventLocation.longitude}}</td>
                        </tr>
                      </table>
                    </div>


                    <!--end new event location mark up-->


                    <p>
                      <div *ngIf="eventLocation.comments && eventLocation.comments.length > 0">
                        <label *ngIf="eventLocation.comments" class="event-detail-label">Comments</label>
                        <br />

                        <span *ngFor="let comment of eventLocation.comments">
                          <b>{{getCommentType(comment.comment_type)}}:</b> {{comment.comment}}
                          <br />
                        </span>
                      </div>

                      <div class="event-detail-action-bar-left">
                        <button mat-stroked-button color="primary" class="event-detail-action-button" (click)="editEventLocation(eventData.eventlocations[i])"
                          [disabled]="!eventData.permissions.update">
                          <i class="material-icons">edit</i> Edit Event Location Details</button>
                        <button mat-stroked-button color="warn" class="event-detail-action-button" (click)="openEventLocationDeleteConfirm(eventData.eventlocations[i].id)"
                          [disabled]="!eventData.permissions.destroy">
                          <i class="material-icons">delete</i> Delete Event Location</button>
                      </div><br />
                      <p>
                        <div *ngIf="eventLocation.locationspecies.length > 0">

                          <label *ngIf="eventLocation.locationspecies" class="event-detail-label text-larger text-bold">Species at this location</label>
                          <br />

                          
                          <app-location-species-table [locationspecies]="eventLocationSpecies"></app-location-species-table>

                          <!-- <div class="results-table-div">

                            <mat-table [dataSource]="eventLocation.locationspecies" matSort matSortActive="species"
                              matSortDirection="asc">

                              <div>
                 
                                <ng-container matColumnDef="select">
                                  <mat-header-cell *matHeaderCellDef>
                                    <mat-checkbox (change)="$event ? masterToggle(i) : null" [checked]="selection[i].hasValue() && isAllSelected(i)"
                                      [indeterminate]="selection[i].hasValue() && !isAllSelected(i)">
                                    </mat-checkbox>
                                  </mat-header-cell>
                                  <mat-cell *matCellDef="let row">
                                    <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? selection[i].toggle(row) : null"
                                      [checked]="selection[i].isSelected(row)">
                                    </mat-checkbox>
                                  </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="species">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Species </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species"> {{loc_species.species_string}} </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="location">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Location </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species">
                                    <span>{{loc_species.administrative_level_two_string}},
                                      {{loc_species.administrative_level_one_string}}</span>
                                  </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="population">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Population </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species"> {{loc_species.population_count}} </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="sick">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Sick </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species"> {{loc_species.sick_count}} </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="dead">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Dead </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species"> {{loc_species.dead_count}} </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="sick_estimated">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Sick Estimate </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species"> {{loc_species.sick_count_estimated}}
                                  </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="dead_estimated">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Dead Estimate </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species"> {{loc_species.dead_count_estimated}}
                                  </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="captive">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Captive </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species"> {{loc_species.captive ? 'Yes': 'No'}}
                                  </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="age_bias">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Age Basis </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species"> {{loc_species.age_bias |
                                    displayValue:'name':this.ageBiases}}
                                  </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="sex_bias">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Sex Bias </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species"> {{loc_species.sex_bias |
                                    displayValue:'name':this.sexBiases}}
                                  </mat-cell>
                                </ng-container>

                                <ng-container matColumnDef="diagnosis">
                                  <mat-header-cell *matHeaderCellDef mat-sort-header> Diagnosis </mat-header-cell>
                                  <mat-cell *matCellDef="let loc_species">
                                    <span *ngIf="loc_species.speciesdiagnoses">
                                      <ul class="table-cell-list">
                                        <li *ngFor="let speciesDiagnosis of loc_species.speciesdiagnoses">{{speciesDiagnosis.diagnosis_string}}</li>
                                      </ul>
                                    </span>
                                  </mat-cell>
                                </ng-container>
                              </div>

                              <mat-header-row *matHeaderRowDef="locationSpeciesDisplayedColumns"></mat-header-row>
                              <mat-row *matRowDef="let loc_species; columns: locationSpeciesDisplayedColumns;"></mat-row>
                            </mat-table>

                            <mat-paginator [pageSizeOptions]="[5, 10, 25]"></mat-paginator>

                            <div class="event-detail-action-bar-left">
                              <button mat-stroked-button color="primary" class="event-detail-action-button" (click)="editSpecies(id, i)"
                                [disabled]="!eventData.permissions.update">
                                <i class="material-icons">edit</i> Edit Species</button>
                              <button mat-stroked-button color="primary" class="event-detail-action-button" (click)="addSpeciesDiagnosis(id, i)"
                                [disabled]="!eventData.permissions.write">
                                <i class="material-icons">add</i> Add Species Diagnosis</button>
                              <button mat-stroked-button color="primary" class="event-detail-action-button" (click)="editSpeciesDiagnosis(id, i)"
                                [disabled]="!eventData.permissions.update">
                                <i class="material-icons">note</i> View Species Diagnosis</button>
                            </div>
                          </div> -->

                        </div>
                  </mat-expansion-panel>

                  <p>

                    <button mat-raised-button color="primary" class="event-detail-action-button" (click)="addEventLocation()"
                      [disabled]="!eventData.permissions.write">
                      <mat-icon>add_location</mat-icon> Add New Event Location
                    </button>
                    <button mat-raised-button color="warn" *ngIf="showAddEventLocation" class="event-detail-action-button"
                      (click)="showAddEventLocation = false;">
                      <mat-icon>remove_circle</mat-icon> Cancel
                    </button>

                    <app-add-event-location *ngIf="showAddEventLocation" [eventID]="eventID"></app-add-event-location>

                    <!-- Add new event location card -->

                    <!--<mat-card-subtitle>Affected Species Summary</mat-card-subtitle>
                
                <table id="speciesList">
                  <tr>
                    <th>Species</th>
                    <th>Location</th>
                    <th>Population</th>
                    <th>Sick</th>
                    <th>Dead</th>
                    <th class="limit-width">Sick Estimate </th>
                    <th class="limit-width">Dead Estimate</th>
                    <th>Diagnosis</th>
                    <th>Diagnosis Basis</th>
                  </tr>

                  <tr *ngFor="let loc_species of eventLocationSpecies">
                    <td>{{loc_species.species_string}}</td>
                    <td>
                      <span>{{loc_species.administrative_level_two_string}}, {{loc_species.administrative_level_one_string}}</span>
                      <br>
                      <span>{{loc_species.country_string}}</span>
                    </td>
                    <td>{{loc_species.population_count}}</td>
                    <td>{{loc_species.sick_count}}</td>
                    <td>{{loc_species.dead_count}}</td>
                    <td>{{sick_count_estimated}}</td>
                    <td>{{dead_count_estimated}}</td>
                    <td>
                      <span *ngIf="loc_species.species_diagnosis.length > 0">
                        <span *ngFor="let species_diagnosis of loc_species.species_diagnosis">
                          <span class="text-bold">{{species_diagnosis.diagnosis.name}}</span>
                          <span *ngIf="species_diagnosis.causal">(Causal)</span>
                          <br>
                          <span class="text-smaller">{{species_diagnosis.tested_count}} specimens tested |</span>
                          <span class="text-smaller">{{species_diagnosis.positive_count}} positive</span>
                          <br>
                          <span class="text-smaller"> by {{species_diagnosis.diagnosis_organization[0].name}}</span>
                        </span>
                      </span>
                      <span *ngIf="loc_species.species_diagnosis.length === 0">Not assessed</span>
                    </td>

                    <td>
                      <span *ngIf="loc_species.species_diagnosis.length > 0">
                        <span *ngFor="let species_diagnosis of loc_species.species_diagnosis">

                          <span *ngIf="species_diagnosis.basis_of_dx">{{species_diagnosis.basis_of_dx}}</span>


                        </span>
                      </span>
                      <span *ngIf="loc_species.species_diagnosis.length === 0">Not assessed</span>
                    </td>

                  </tr>
                </table>-->

          </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="mapDiv">
    <mat-card>
      <div id="map">
        <mat-card class="unmappable-warning" *ngIf="unMappables.length > 0" matTooltip="Exact latitude and longitude for the listed locations are absent in the WHISPers database."
          [matTooltipPosition]="'above'">
          <span>
            <mat-icon>warning</mat-icon>&nbsp;Some location data absent. The following locations are not mapped:
            <!-- <ul>
              <li *ngFor="let unmappable of unMappables">{{unmappable.name}} ({{unmappable.administrative_level_two_string}},
                {{unmappable.administrative_level_one_string}})
              </li>
            </ul> -->

            <span *ngFor="let unmappable of unMappables">{{unmappable.name}}
              ({{unmappable.administrative_level_two_string}},
              {{unmappable.administrative_level_one_string}})
              <span *ngIf="(unMappables.indexOf(unmappable)) < (unMappables.length - 1)">;</span></span>

          </span>
        </mat-card>

        <mat-expansion-panel id="legend" class="legend">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>view_list</mat-icon>
            </mat-panel-title>
            <mat-panel-description>
              Legend
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="legend-panel-content">

            <span>
              <div id='iconHolder'>
                <div class='wmm-pin wmm-white wmm-icon-circle wmm-icon-black wmm-size-25'></div>
              </div>
              <label id='expLabel'>Event Location</label>
            </span>

            <div id="flywaysLegend" *ngIf="flywaysVisible">
              <div class="legend-label"><label>Flyways</label></div>
              <span>
                <div id='iconHolder'>
                  <div class='wmm-square wmm-blue wmm-icon-noicon wmm-icon-white wmm-size-20 flyway-blue'></div>
                </div>
                <label id='expLabel'>Atlantic Flyway</label>
              </span>
              <br />
              <span>
                <div id='iconHolder'>
                  <div class='wmm-square wmm-yellow wmm-icon-noicon wmm-icon-white wmm-size-20 flyway-yellow'></div>
                </div>
                <label id='expLabel'>Central Flyway</label>
              </span>
              <br />
              <span>
                <div id='iconHolder'>
                  <div class='wmm-square wmm-green wmm-icon-noicon wmm-icon-white wmm-size-20 flyway-green'></div>
                </div>
                <label id='expLabel'>Mississippi Flyway</label>
              </span>
              <br />
              <span>
                <div id='iconHolder'>
                  <div class='wmm-square wmm-red wmm-icon-noicon wmm-icon-white wmm-size-20 flyway-red'></div>
                </div>
                <label id='expLabel'>Pacific Flyway</label>
              </span>
            </div>

            <div id="watershedsLegend" *ngIf="watershedsVisible">
              <div class="legend-label"><label>Watersheds</label></div>
              <span>
                <div id='iconHolder'>
                  <div class='wmm-square wmm-white wmm-icon-circle wmm-icon-white wmm-size-20 huc-icon'></div>
                </div>
                <label id='expLabel'>HUC 2</label>
              </span>
            </div>
          </div>

        </mat-expansion-panel>
      </div>
    </mat-card>
  </div>

</div>